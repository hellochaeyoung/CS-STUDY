## 쿠키와 세션

로그인 기능을 구현하고 로그인 후 사용자 별로 홈 화면에 이름을 표시하는 등 사용자 인증 기능과 사용자마다 사용자 만의 정보로 
동적 처리를 해야할 때 어떤 기술을 사용해야 할까?

이렇게 웹에서 사용자, 즉 로그인 기능을 구현하려면 필수적인 기능인 쿠키와 세션에 대해 강의를 통해 알게 된 내용을 정리해보고자 한다.


### 1. HTTP만의 특징

   HTTP 프로토콜은 **connectionless, stateless**한 특성을 가지고 있다. 따라서 매번 서버는 클라이언트가 누구인지 확인하는 과정이 필요하다.
   
   * connectionless : 클라이언트가 요청한 후 서버로부터 응답을 받으면 그 연결을 끊어버리는 특징
   * stateless : 통신이 끝나면 상태를 유지하지 않는 특징 -> 연결을 끊는 순간 클라이언트 - 서버 간의 통신이 끝나며 상태 정보는 유지하지 않는다.
   
   만약 쿠키와 세션을 사용하지 않으면 인증이 필요한 페이지로 이동 시 마다 쿼리 파라미터를 계속 유지하며 로그인을 해야한다.
   
   이러한 단점을 보완하고자 쿠키와 세션을 사용하게 되었다.


### 2. 쿠키

   쿠키는 클라이언트, 즉 브라우저 로컬에 저장되는 key-value로 이루어진 데이터이다.
   
   로그인 성공 시 서버에서 HTTP response에 쿠키를 담아서 브라우저에 전달해주면 **브라우저는 로컬 쿠키 저장소에 쿠키 값을 저장**해두고 
   **HTTP request를 보낼 때마다 요청 헤더에 쿠키 값을 담아서** 보낸다. -> 서버는 이 쿠키 값을 통해 사용자를 구분하고 이에 맞는 응답을 보낸다.
   
   ![image](https://user-images.githubusercontent.com/55968079/164892705-26166cd6-2d96-4823-86c3-69f94b5b4f3b.png)

    
   ![image](https://user-images.githubusercontent.com/55968079/164892714-cf0cde9b-23bb-4146-869e-d0aa50637908.png)

  * 쿠키의 종류
    * 영속 쿠키 : 만료 날짜를 입력 시 해당 날짜까지 유지
    * 세션 쿠키 : 만료 날짜를 생략하면 **브라우저 종료 시** 까지만 유지 -> 대부분 브라우저 종료 시 로그아웃 되기를 원하므로 세션 쿠키를 더 많이 사용한다.
   
   
  * 쿠키의 보안 문제
    * 쿠키 값은 임의로 브라우저에서 변경 가능하다 -> 다른 사용자로 접속이 가능해진다.
    * 쿠키에 보관된 정보는 훔쳐갈 수 있다 -> PC나 네트워크 전송 구간에서도 털릴 가능성이 있다.
    * 해커가 쿠키를 한 번 훔쳐가면 평생 사용 가능하다. -> 해커가 훔친 쿠키로 악의적인 요청을 계속 시도할 수 있다.
   
   따라서, 위와 같은 쿠키의 한계점을 보완하고자 다음과 같은 대책이 필요하다.
   
  * 쿠키에 중요한 값을 담지 않고 사용자 별로 예측 불가능한 임의의 토큰을 노출하고 서버에서 토큰과 사용자 id를 매핑해 인식하는 방법을 사용해야 한다.
    -> 이 토큰은 서버에서 관리
  * 토큰이 일정 시간이 지나면 사용할 수 없게끔 서버에서 해당 토큰의 만료시간을 짧게 지정하여 유지한다.
   
  => 이러한 대책을 수행해줄 수 있는 것이 바로 **세션**이다.
  

### 3. 세션

   쿠키는 클라이언트에서 관리되기 때문에 중요한 정보일 시 보안의 위험이 있어 중요한 정보는 모두 서버에 저장해야 한다.
   
   또한 클라이언트와 서버는 추정 불가능한 임의의 식별자 값으로 연결되어야 한다.
   
   -> 이렇게 **서버**에 중요한 정보를 보관하고 연결을 유지하는 방법을 세션이라 한다.
   
   ![image](https://user-images.githubusercontent.com/55968079/164893096-8a846bdf-00b1-444f-bfd2-b841e8e6916d.png)


   ![image](https://user-images.githubusercontent.com/55968079/164893114-19c496c9-d69e-4e31-a264-d2ed4b4cc671.png)


   ![image](https://user-images.githubusercontent.com/55968079/164893139-43d08e82-bab3-4626-b24b-55eafd0fe86f.png)


   클라이언트에서 로그인 요청을 보내면 서버는 회원 저장소에서 일치하는지 확인 후 추정 불가능한 임의의 값인 UUID로 세션ID를 설정 후 세션 저장소에 저장한다.
   
   서버는 **세션ID만 쿠키에 담아** 클라이언트로 HTTP response를 보낸다. -> 이렇게 함으로써 중요 데이터는 노출되지 않고 클라이언트와 서버가 쿠키로 연결될 수 있다.
   
   
   ![image](https://user-images.githubusercontent.com/55968079/164893242-c6e06a4f-f842-4301-b415-bcee009cbdcf.png)


   로그인 이후에는 위와 같이 요청 시마다 항상 세션ID를 담은 쿠키를 전달하고 서버는 이 정보를 사용하게 된다.
   
   
  * 하지만 세션은 메모리에 생성되는 것으로 메모리 영역을 차지한다. -> 따라서 요청마다 세션을 생성하게 되면 다중 사용자가 접속 시 메모리 초과로 서버가 다운될 수 있다.
    따라서 꼭 필요한 경우에만 생성해서 사용해야 하고 무분별한 생성은 방지해야한다.
     
    현재는 이러한 메모리 문제 등으로 인한 단점을 보완하기 위해 토큰 기반 인증 방식을 많이 사용한다. 추후에 JWT에 대해서도 다시 한번 정리해야겠다.
